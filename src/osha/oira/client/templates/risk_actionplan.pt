<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      xmlns:meta="http://xml.zope.org/namespaces/meta"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      meta:interpolation="true"
      i18n:domain="euphorie"
      tal:define="client nocall:request/client; webhelpers nocall:context/@@webhelpers"
      metal:use-macro="context/@@shell/macros/shell">

<body>
<metal:slot fill-slot="content" tal:define="risk nocall:view/risk|nothing; data view/data">
<tal:block replace="tile:statusmessages"/>
<tal:def define="errors python:exists('actionplan/errors') and actionplan['errors'] or {};">

<!-- TODO: This needs to be integrated into site's CSS somehow -->
<style> .measures .measure .functions a.disabled { display: none; } </style>

<form method="post" action="${context/absolute_url}" class="pat-inject pat-validate"
    data-pat-validate="disable-selector: button[name='next'], .remove-clone"
    data-pat-inject="history: record; source: #step-4; target: #step-4 && source: #content; target: #content">
<article class="rich pat-well warning" id="${view/risk_number}">
    <tal:block condition="not:view/risk_present">
        <h2 tal:content="risk/title"></h2>
    </tal:block>
    <tal:block condition="view/risk_present" define="use_problem_description view/use_problem_description">
        <h2 tal:condition="use_problem_description"
            tal:content="risk/problem_description">The fridges are checked daily.</h2>
        <h2 tal:condition="not:use_problem_description"
            tal:content="risk/title">The fridges are checked daily.</h2>
    </tal:block>
    <tal:priority tal:define="show_statement python:True">
        <fieldset tal:define="value data/priority">
            <label i18n:translate="risk_priority">This is a <select name="priority" i18n:name="priority_value">
            <option value="low" selected="${python:'selected' if value=='low' else None}" i18n:translate="risk_priority_low">low</option>
            <option value="medium" selected="${python:'selected' if value=='medium' else None}" i18n:translate="risk_priority_medium">medium</option>
            <option value="high" selected="${python:'selected' if value=='high' else None}" i18n:translate="risk_priority_high">high</option>
            </select> priority risk.</label>
        </fieldset>
        <metal:call use-macro="webhelpers/macros/risk_info_actionplan" />
    </tal:priority>

    <div class="last span-15" tal:condition="risk/legal_reference|nothing">
        <metal:call use-macro="webhelpers/macros/risk_legal_collapsible" />
    </div>

</article>


<div class="measures pat-clone" data-pat-clone="template: #measure-template" id="ActionPlanItemForm">
    <div class="measure clone pat-collapsible"
         tal:define="measures view/solutions|python:[]"
        tal:repeat="actionplan data/action_plans">

        <h2 tal:content="string:Measure ${repeat/actionplan/number}">Measure 1</h2>
        <p class="functions">
            <a class="icon-pencil pat-tooltip" tal:condition="measures" data-pat-tooltip="source:ajax" href="#standard-solutions-0">Pre-fill</a>
            <a class="icon-trash remove-clone">Remove</a>
        </p>
        <tal:if_has_measures condition="measures">
            <div id="standard-solutions-0" hidden>
                <p class="info" i18n:translate="label_select_measure">Select one or more of the known common measures provided.</p>
                <ol class="add-measure-menu">
                    <li tal:repeat="measure measures">
                        <a class="pat-inject close-panel"
                        href="#standard-solution-${repeat/measure/number}"
                        data-pat-inject="target: #fields-0" class="title">
                        <em class="small pat-button">Add</em>${measure/description}</a>
                    </li>
                </ol>
            </div>
        </tal:if_has_measures>

        <fieldset class="vertical" id="fields-0">
            <label>Description
                <dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt" i18n:translate="actionplan_measure_tooltip">Describe: 1) what is your general approach to eliminate or (if the risk is not avoidable) reduce the risk; 2) the specific action(s) required to implement this approach (to eliminate or to reduce the risk); 3) the level of expertise needed to implement the measure, for instance “common sense (no OSH knowledge required)”, “no specific OSH expertise, but minimum OSH knowledge or training and/or consultation of OSH guidance required”, or “OSH expert”. You can also describe here any other additional requirement (if any).</dfn>
                <textarea class="actionPlan" type="text" name="measure.action_plan:utf8:ustring:records" rows="6"
                    placeholder="General approach (to eliminate or reduce the risk)"
                    i18n:attributes="placeholder label_measure_action_plan"
                    tal:content="actionplan/action_plan|nothing"></textarea>
            </label>
            <label>Prevention plan
                <textarea class="preventionPlan" name="measure.prevention_plan:utf8:ustring:records" rows="3"
                    placeholder="Specific action(s) required to implement this approach"
                    i18n:attributes="placeholder label_measure_prevention_plan"
                    tal:content="actionplan/prevention_plan|nothing"></textarea>
            </label>
            <label>Requirements
                <textarea class="requirements" name="measure.requirements:utf8:ustring:records" rows="3"
                    placeholder="Level of expertise and/or requirements needed"
                    i18n:attributes="placeholder label_measure_requirements"
                    tal:content="actionplan/requirements|nothing"></textarea>
            </label>
        </fieldset>

        <fieldset class="vertical" tal:define="number repeat/actionplan/number">
            <label>
                <tal:span i18n:translate="label_action_plan_responsible">Who is responsible?</tal:span>
                <dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt" i18n:translate="actionplan_measure_responsible_tooltip">Appoint someone in your company to be responsible for the implementation of this measure. This person will have the authority to take the steps described in the Plan and/or the responsibility to ensure that they are carried out.</dfn>
                <input type="text" class="responsible" name="measure.responsible:utf8:ustring:records" value="${actionplan/responsible|nothing}"/>
            </label>
            <label class="currency" class="${python:'error' if exists('errors/budget') else None}">
                <tal:span i18n:translate="label_action_plan_budget">Budget</tal:span>
                <em class="message error" tal:condition="exists:errors/budget" i18n:translate="error_invalid_budget">Please enter the budget in whole Euros.</em>
                <dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt" i18n:translate="actionplan_measure_budget_tooltip">Although some measures do not cost any money, most do. The measures should therefore be budgeted for; include them in the annual budget round if necessary.</dfn>
                <span class="composed currency-field">
                    <input type="number" class="currency" name="measure.budget:records" id="input-budget-${number}" value="${actionplan/budget|nothing}"/>
                </span>
            </label>

            <label tal:define="date_error exists:errors/planning_start_date">
                <tal:label i18n:translate="label_action_plan_start">Planning start</tal:label>
                <em class="message error" tal:condition="date_error" i18n:translate="error_start_not_before_end">Start date is not before end date</em>
                <input
                    type="date" class="pat-date-picker" data-pat-date-picker="behavior: native" name="measure.planning_start:records"
                    id="planning-start-${number}"
                    value="${actionplan/planning_start|nothing}"/>
            </label>

            <label tal:define="date_error exists:errors/planning_end_date">
                <tal:label i18n:translate="label_action_plan_end">Planning end</tal:label>
                <em class="message error" tal:condition="date_error" i18n:translate="error_end_not_before_end">End date is not after start date</em>

                <input parsley-onorafterdate="#planning-start-${number}"
                    type="date" class="pat-date-picker" data-pat-date-picker="behavior: native" name="measure.planning_end:records"
                    id="planning-end-${number}"
                    value="${actionplan/planning_end|nothing}"/>
            </label>
        </fieldset>
    </div>
</div>

	<div class="button-bar">
		<button class="add-clone pat-button icon-plus-circle" id="addMeasureButton" title="Add another measure" type="button">Add another measure</button>
	</div>

	<div class="measure pat-collapsible" id="measure-template" hidden>
        <tal:get_measures define="measures view/solutions|python:[]">
		<h2>Measure #{1}</h2>
		<p class="functions">
			<a class="icon-pencil pat-tooltip" tal:condition="measures" data-pat-tooltip="source: ajax" href="#standard-solutions-#{1}">Pre-fill</a>
			<a class="icon-trash remove-clone">Remove</a>
		</p>

        <tal:if_has_measures condition="measures">
		<div id="standard-solutions-#{1}" hidden>
            <p class="info" i18n:translate="label_select_measure">Select one or more of the known common measures provided.</p>
            <ol class="add-measure-menu">
                <li tal:repeat="solution measures">
                    <a class="pat-inject close-panel"
                       class="title"
                       href="#standard-solution-${repeat/solution/number}"
                       data-pat-inject="target: #fields-#{1}">
                    <em class="small pat-button">Add</em>${solution/description}</a>
                </li>
            </ol>
        </div>
        </tal:if_has_measures>
        </tal:get_measures>

		<fieldset class="vertical" id="fields-#{1}">
			<label>Description
				<dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt">Describe: 1) what is your general approach to eliminate or (if the risk is not avoidable) reduce the risk; 2) the specific action(s) required to implement this approach (to eliminate or to reduce the risk); 3) the level of expertise needed to implement the measure, for instance “common sense (no OSH knowledge required)”, “no specific OSH expertise, but minimum OSH knowledge or training and/or consultation of OSH guidance required”, or “OSH expert”. You can also describe here any other additional requirement (if any).</dfn>
				<textarea autofocus class=" actionPlan" name="measure.action_plan:utf8:ustring:records" placeholder="General approach (to eliminate or reduce the risk)" rows="6"></textarea>
			</label>
			<label>Prevention plan
				<textarea class="preventionPlan" name="measure.prevention_plan:utf8:ustring:records" placeholder="Specific action(s) required to implement this approach" rows="3"></textarea>
			</label>
			<label>Requirements
				<textarea class="requirements" name="measure.requirements:utf8:ustring:records" placeholder="Level of expertise and/or requirements needed" rows="3"></textarea>
			</label>
		</fieldset>

		<fieldset class="vertical">
			<label>
				Who is responsible?
				<dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt">Appoint someone in your company to be responsible for the implementation of this measure. This person will have the authority to take the steps described in the Plan and/or the responsibility to ensure that they are carried out.</dfn>
				<input class="responsible" name="measure.responsible:utf8:ustring:records" type="text">
			</label>
			<label class="currency">
				Budget
				<dfn class="icon-help-circle iconified pat-tooltip" data-pat-tooltip="source: content; position-list: lt">Although some measures do not cost any money, most do. The measures should therefore be budgeted for; include them in the annual budget round if necessary.</dfn>
                <span class="composed currency-field">
                    <input type="number" class="currency" name="measure.budget:records" id="input-budget-#{1}" />
                </span>
			</label>
			<label>
                <tal:label i18n:translate="label_action_plan_start">Planning start</tal:label>
                <input type="date" class="pat-date-picker" data-pat-date-picker="behavior: native" name="measure.planning_start:records" id="planning-start-#{1}" />
			</label>
			<label>
                <tal:label i18n:translate="label_action_plan_end">Planning end</tal:label>
                <input parsley-onorafterdate="#planning-start-#{1}" type="date" class="pat-date-picker" data-pat-date-picker="behavior: native" name="measure.planning_end:records" id="planning-end-#{1}"/>
			</label>
		</fieldset>
	</div>

    <fieldset id="comments">
        <textarea id="commentsField" name="comment:utf8:ustring" cols="70" rows="5"
            placeholder="Please leave any comments you may have on the question above in this field. These comments will be used in the action plan."
            i18n:attributes="placeholder label_comment"
            tal:content="data/comment|nothing"></textarea>
    </fieldset>

    <div class="button-bar">
        <button type="submit" name="next" value="previous"
                i18n:translate="label_previous" class="pat-button">Previous</button>
        <button type="submit" name="next" value="next" data-pat-switch="${python:view.next_is_report and 'selector: body; remove: sidebar-on; add: sidebar-off' or ''}"
                i18n:translate="label_save_and_continue" class="pat-button ${python: view.next_is_report and 'pat-switch' or ''}">Save and continue</button>
    </div>
    </form>

    <tal:loop repeat="solution view/solutions|python:[]">
        <fieldset class="vertical" id="standard-solution-${repeat/solution/number}" hidden>
            <label>Description
                <textarea class="actionPlan" name="measure.action_plan:utf8:ustring:records" placeholder="General approach (to eliminate or reduce the risk)" rows="6">${solution/description}</textarea>
            </label>
            <label>Prevention plan
                <textarea class="preventionPlan" name="measure.prevention_plan:utf8:ustring:records" placeholder="Specific action(s) required to implement this approach" rows="3">${solution/action_plan}</textarea>
            </label>
            <label>Requirements
                <textarea class="requirements" name="measure.requirements:utf8:ustring:records" placeholder="Level of expertise and/or requirements needed" rows="3">${solution/requirements}</textarea>
            </label>
        </fieldset>
    </tal:loop>
</tal:def>

</metal:slot>
</body>
</html>
